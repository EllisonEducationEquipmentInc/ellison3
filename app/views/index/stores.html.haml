- content_for :gmap_header do
  = javascript_include_tag 'http://maps.google.com/maps/api/js?v=3.3&sensor=false'
  = javascript_include_tag '/javascripts/vendor/markermanager.js'
  = javascript_include_tag '/javascripts/vendor/StyledMarker.js'
  / = javascript_include_tag '/javascripts/vendor/jquery.metadata.js'
  = javascript_include_tag 'jquery.jmapping.js'
.tab-block
  %ul
    %li.rounded_top= link_to "Stores", "#stores"
    %li.rounded_top= link_to "Online Retailers", "#online_retailers"
    %li.rounded_top= link_to "Distributors", "#distributors"
    %li.rounded_top= link_to "Major Retailers", "#major_retailers"
  #stores
    %h2 Stores
    #store_info
      = form_tag '#', :onsubmit => 'return false' do
        .field 
          Country: 
          = select_tag :country, options_for_select(@countries, params[:country]), :onchange => "toggle_store_fields()"
        .field.us_only
          Zip Code:
          = text_field_tag :zip_code, params[:zip_code]
        .field.us_only
          Radius:
          = select_tag :radius, options_for_select([5,10,20,30,50], params[:radius] || 5)
          miles
        .field
          = link_to 'search', '#', :id => 'map_search_submit'
      #map-side-bar
    #map
  .clear
  #online_retailers
    %h2 Online Retailers
  #distributors 
    %h2 Distributors
  #major_retailers 
    %h2 Major Retailers

:javascript
  $(document).ready(function(){
    $(".tab-block").tabs();
    toggle_store_fields();
    $.getScript('/javascripts/vendor/jquery.metadata.js', function() {
      $('#map').jMapping({default_point: {lat: 40.513799, lng:-98.876953}, default_zoom_level: 3});
    });
    $('#map_search_submit').click( function() {
      if ($('#country').val() == 'United States' && $('#zip_code').val().length < 5) {
        alert('invalid zip code');
        return false;
      }
      $.ajax({url:'/index/update_map?'+$(this).parents('form').serialize(), success: function(html){
        $('#map-side-bar').html(html);
        $('#map').jMapping('update');
      }});
      return false;
    });
  }).bind('afterMapping.jMapping', function(e,m) {
    setTimeout("$('#map').data('jMapping').map.setZoom(4)", 1200);
  });
  function toggle_store_fields(){
    if ($('#country').val() == 'United States'){
      $('.us_only').show();
    } else {
      $('.us_only').hide();
    }
  }
  

